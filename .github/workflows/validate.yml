name: validate marketplace

on:
  pull_request:
  push:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: validate json files
        run: |
          echo "ğŸ” validating json files..."

          # validate marketplace.json
          if ! jq empty marketplace.json 2>/dev/null; then
            echo "âŒ invalid marketplace.json"
            exit 1
          fi
          echo "âœ… marketplace.json valid"

          # validate plugin.json
          if ! jq empty .claude-plugin/plugin.json 2>/dev/null; then
            echo "âŒ invalid .claude-plugin/plugin.json"
            exit 1
          fi
          echo "âœ… plugin.json valid"

      - name: validate skills structure
        run: |
          echo "ğŸ” validating skills..."

          # check archon skill has SKILL.md
          if [ ! -f "skills/archon/SKILL.md" ]; then
            echo "âŒ skills/archon/SKILL.md missing"
            exit 1
          fi

          # validate archon SKILL.md has yaml frontmatter
          if ! head -1 "skills/archon/SKILL.md" | grep -q "^---$"; then
            echo "âŒ skills/archon/SKILL.md missing yaml frontmatter"
            exit 1
          fi

          echo "âœ… skill archon valid"

      - name: validate agents structure
        run: |
          echo "ğŸ” validating agents..."

          for agent in agents/*/*.md; do
            if [ ! -f "$agent" ]; then
              continue
            fi

            # check yaml frontmatter exists
            if ! head -1 "$agent" | grep -q "^---$"; then
              echo "âŒ $agent missing yaml frontmatter"
              exit 1
            fi

            echo "âœ… $agent valid"
          done

          echo "âœ¨ all agents validated!"

      - name: validate commands structure
        run: |
          echo "ğŸ” validating commands..."

          for command in commands/*/*.md; do
            if [ ! -f "$command" ]; then
              continue
            fi

            # check yaml frontmatter exists
            if ! head -1 "$command" | grep -q "^---$"; then
              echo "âŒ $command missing yaml frontmatter"
              exit 1
            fi

            echo "âœ… $command valid"
          done

          echo "âœ¨ all commands validated!"

      - name: check required files
        run: |
          echo "ğŸ” checking required files..."

          required_files=(
            "README.md"
            "CHANGELOG.md"
            "marketplace.json"
            ".claude-plugin/plugin.json"
          )

          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ required file missing: $file"
              exit 1
            fi
            echo "âœ… $file exists"
          done

          echo "âœ¨ all required files present!"

      - name: summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… validation complete!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“¦ marketplace structure:"
          echo "  - 2 agents (1-vibeplanning)"
          echo "  - 6 commands (2-context-engineering, 3-implementation, 6-extra, 8-documentation)"
          echo "  - 1 skill (archon)"
          echo ""
          echo "ğŸ‰ ready for release!"
